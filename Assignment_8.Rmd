---
title: "Assignment 8 - Permutation Test & Machine Learning"
author: "Julie Li"
date: "2024-12-4"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

## Load Libraries : Need to be run for every new session
```{r, message = FALSE}
library(tidyverse)
library(reshape2)
library(coin) # Permutation test
library(faux) # simulate multivariate normal distributed data

library(glmnet) # Penalized regression
library(caret) # Machine Learning
library(AppliedPredictiveModeling)
library(umap) # UMAP clustering

library(ROCR) # ROC plots
library(plotROC)
library(pROC)

library(edgeR) # RNAseq analysis
library(viridis) # color for heatmap
library(ggrepel) # labels in ggplot

# Set global ggplot theme
theme_set(theme_grey() + theme(text = element_text(size = 24), legend.position="bottom"))
```

## Task 1. A dataset of three variables (`X`, `null.Y`, `alt.Y`) of `1000` samples were generated from normal distributions. Variable `null.Y` has correlation `0` with `X`, while `alt.Y` has correlation `0.2` with `X`. In the following tasks, you are asked to use the data generated by the code below to conduct *Spearman correlation test*, with null hypothesis of `correlation=0`, and alternative hypothesis of `correlation!=0`  (use significance level `0.05`, and two-sided test). 

### Generate data 
```{r}
set.seed(2024)
dat <- rnorm_multi(n = 1000, 
                  mu = c(0, 1, 1),
                  sd = c(1, 2, 2),
                  r = c(0, 0.2, 0), 
                  varnames = c("X", "null.Y", "alt.Y"),
                  empirical = FALSE)

### Check sample means, standard deviations, and correlations
# Variable means
apply(dat, 2, mean)

# Variable standard deviations
apply(dat, 2, sd)

# Spearman correlation matrix
cor(dat, method = "spearman")
```

### Task 1.1. Plot histograms of `null.Y` and `alt.Y`. Plot scatter plots of `X` vs. `null.Y`, and `X` vs. `alt.Y`, with a regression line (Hint: use `geom_smooth(method='lm', formula= y~x)`). 
```{r}
ggplot(dat, aes(x = null.Y)) +
  geom_histogram(binwidth = 0.5, fill = 'pink', color = 'black') +
  ggtitle('Histogram of null.Y') +
  theme_minimal()

ggplot(dat, aes(x = alt.Y)) +
  geom_histogram(binwidth = 0.5, fill = 'purple', color = 'black') +
  ggtitle('Histogram of alt.Y') +
  theme_minimal()

```
```{r}
ggplot(dat, aes(x = X, y = null.Y)) +
  geom_point() +
  geom_smooth(method='lm', formula= y ~ x) +
  ggtitle('Scatter plot of X vs null.Y') +
  theme_minimal()

ggplot(dat, aes(x = X, y = alt.Y)) +
  geom_point() +
  geom_smooth(method='lm', formula= y ~ x) +
  ggtitle('Scatter plot of X vs alt.Y') +
  theme_minimal()

```


### Task 1.2. Apply `cor.test(, method = "spearman")` to `X` vs. `null.Y`; `X` vs. `alt.Y`; to calculate `p-value` for testing *Spearman correlation* and state your test p-values and conclusion.
```{r}
cor_test_null <- cor.test(dat$X, dat$null.Y, method = "spearman")
print(cor_test_null$p.value)

cor_test_alt <- cor.test(dat$X, dat$alt.Y, method = "spearman")
print(cor_test_alt$p.value)


if (cor_test_null$p.value < 0.05) {
  print("Reject null hypothesis")
} else {
  print("Fail to reject null hypothesis")
}

if (cor_test_alt$p.value < 0.05) {
  print("Reject null hypothesis")
} else {
  print("Fail to reject null hypothesis")
}

```


### Task 1.3. Write your own R scripts to calculate the `permutation p-value` for a *two-sided Spearman correlation test* of `X` and `null.Y`, `X` and `alt.Y`. Plot histograms of your test statistic (Spearman correlation between two test variables) under `1000` permutations with a line denoting the sample Spearman correlations (given by `cor(X, Y, method = "spearman")` or the above `cor(dat, method = "spearman")`), calculate `permutation p-value`, and state your test p-values and conclusion. (Hint: *Spearman correlation* is the test statistic you shall consider. Need to permute values in the `X` vector).
```{r}
permute_spearman <- function(X, Y, num_perm = 1000) {
  observed_corr <- cor(X, Y, method = "spearman")
  permuted_corrs <- replicate(num_perm, cor(sample(X), Y, method = "spearman"))
  
  hist(permuted_corrs, main = "Permuted Spearman Correlations - Histogram",
       xlab = "Spearman Correlation", col = 'purple', border = 'black')
  abline(v = observed_corr, col = 'pink', lwd = 2)
  
  p_value <- mean(abs(permuted_corrs) >= abs(observed_corr))
  return(p_value)
}

p_value_null <- permute_spearman(dat$X, dat$null.Y)
print(p_value_null)

p_value_alt <- permute_spearman(dat$X, dat$alt.Y)
print(p_value_alt)

```


### Task 1.4. Apply `independence_test()` from the `coin` library to `X` and `null.Y`, `X` and `alt.Y`, to calculate `p-value` for testing *Spearman correlation* and state your test p-values and conclusion.
```{r}
library(coin)

indep_test_null <- independence_test(null.Y ~ X, data = dat, alternative = "two.sided", distribution = approximate(nresample = 10000))
print(pvalue(indep_test_null))

indep_test_alt <- independence_test(alt.Y ~ X, data = dat, alternative = "two.sided", distribution = approximate(nresample = 10000))
print(pvalue(indep_test_alt))
if (pvalue(indep_test_null) < 0.05) {
  print("Reject null hypothesis")
} else {
  print("Fail to reject null hypothesis")
}

if (pvalue(indep_test_alt) < 0.05) {
  print("Reject null hypothesis")
} else {
  print("Fail to reject null hypothesis")
}

```


## Task 2. Complete the following tasks that follow your in-class activity. 

### First Load RNAseq Data as follows. The `TCGA-LUAD-mRNA.tsv` file contains mRNA expression z-scores relative to normal samples. The second column of `Sample_Label` denotes disease status (simulated). 

```{r}
mRNAexp <- read_tsv("./DataSets/TCGA-LUAD-mRNA.tsv")
dim(mRNAexp) 
head(mRNAexp)
```

#### In-class activity: Set a seed by `set.seed()` function. Create data partition of `70%` training and `30%` test data by `createDataPartition()`.
```{r, eval = FALSE}
set.seed(2024)
trainIndex <- createDataPartition(mRNAexp$Sample_Label, times = 1, p = 0.7, list = FALSE)
head(trainIndex)
```

#### In-class activity: Use the following training parameters to train the model using the `glmnet` method by `train()` function. Explain what is 5-fold cross validation, plot your training results, and state what is your best tuned model. 
```{r, eval = FALSE}
fitControl <- trainControl(method = "cv",
                           number = 5, 
                           classProbs = TRUE,
                           summaryFunction = twoClassSummary)

glmnet.fit <- train(
  x = mRNAexp[trainIndex, -1], y = mRNAexp$Sample_Label[trainIndex],
  method = "glmnet",
  trControl = fitControl,
  preProc = c("center", "scale"),
  tuneGrid = expand.grid(alpha = seq(0, 1, length.out = 5), 
                         lambda = c(0.01, 0.1, 0.2)),
  metric = "ROC"
)

trellis.par.set(caretTheme())
plot(glmnet.fit)

glmnet.fit$bestTune
print(glmnet.fit)
```

### Task 2.1: Get predicted labels of your test data by `predict()`, and print the confusion matrix by `confusionMatrix()`.
```{r}
predicted_labels <- predict(glmnet.fit, newdata = mRNAexp[-trainIndex, ])

actual_labels <- factor(mRNAexp$Sample_Label[-trainIndex])
predicted_labels <- factor(predicted_labels, levels = levels(actual_labels))

conf_matrix <- confusionMatrix(predicted_labels, actual_labels)
print(conf_matrix)
```


### Task 2.2: Make ROC plot with your test restuls given by `predict(, type="prob")`
```{r}
predicted_probs <- predict(glmnet.fit, newdata = mRNAexp[-trainIndex, ], type = "prob")
roc_obj <- roc(response = mRNAexp$Sample_Label[-trainIndex], predictor = predicted_probs[,2])
plot(roc_obj, col = 'purple', main = "ROC Plot")
```


### Task 2.3:  Clustering samples by `hclust(, method = "average")` and plot your results.
```{r}
dist_matrix <- dist(mRNAexp[,-1])
hc <- hclust(dist_matrix, method = "average")
plot(hc)
```


### Task 2.4:  Clustering samples by `umap()` and plot your results.
```{r}
mRNAexp_numeric <- mRNAexp %>% select_if(is.numeric)

umap_results <- umap(mRNAexp_numeric)

umap_df <- as.data.frame(umap_results$layout)
umap_df$Sample_Label <- mRNAexp$Sample_Label

ggplot(umap_df, aes(x = V1, y = V2, color = Sample_Label)) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "UMAP Clustering of Samples", x = "UMAP1", y = "UMAP2")

```



